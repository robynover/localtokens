function readCookie(name){for(var nameEQ=name+"=",ca=document.cookie.split(";"),i=0;i<ca.length;i++){for(var c=ca[i];" "==c.charAt(0);)c=c.substring(1,c.length);if(0==c.indexOf(nameEQ))return c.substring(nameEQ.length,c.length)}return null}function createCookie(name,value,days){var expires="";if(days){var date=new Date;date.setTime(date.getTime()+24*days*60*60*1e3),expires="; expires="+date.toUTCString()}document.cookie=name+"="+value+expires+"; path=/"}if($(".sendtokens").length>0&&$(".sendtokens form").on("submit",function(e){return e.preventDefault(),$("#amt").val().length<1?(alert("Please enter an amount of tokens to send"),!1):$('input[name="receiver"]').val().length<3?(alert("The receiver username is not valid"),!1):void this.submit()}),$("#new-msg-form").length>0&&$("#new-msg-form").on("submit",function(e){return e.preventDefault(),$("#new-msg-form .msgtitle").val().length<1?($(".field-validation").text("Title cannot be empty"),!1):$("#new-msg-form .msgbody").val().length<1?($(".field-validation").text("Body cannot be empty"),!1):$("#new-msg-form .contactinput").val().length<1?($(".field-validation").text("Contact info cannot be empty"),!1):($('input[type="submit"]').val("uploading ..."),void this.submit())}),"undefined"!=typeof validate){validate.validators.usernameIsUnique=function(value){return console.log("usernameIsUnique"),new validate.Promise(function(resolve,reject){$.ajax({method:"POST",url:"/api/user/"+value+"/exists"}).done(function(data){console.log(data),!0===data.success?resolve("already exists"):resolve()})})};var constraints={username:{presence:!0,length:{minimum:3,maximum:20},format:{pattern:"[a-z0-9]+",flags:"i",message:"can only contain a-z and 0-9"}},password:{presence:!0,length:{minimum:6,message:"must be at least 6 characters"}},email:{email:!0},firstname:{presence:!0}},usernameConstraints={username:{presence:!0,length:{minimum:3,maximum:20},usernameIsUnique:!0,format:{pattern:"[a-z0-9]+",flags:"i",message:"can only contain a-z and 0-9"}}},success=function(){$(".field-validation.username").text("")},error=function(errors){var msg="";msg="object"==typeof errors?errors.username[0]:errors[0],$(".field-validation.username").text(msg)};$('input[name="username"]').blur(function(){validate.async({username:this.value},usernameConstraints).then(success,error)}),$('input[name="password_confirm"]').blur(function(){this.value===$('input[name="password"]')[0].value?$(this).parent().parent().find(".field-validation.password_confirm").text(""):$(this).parent().parent().find(".field-validation.password_confirm").text("Passwords do not match")});var form=$("#signup"),formValues=validate.collectFormValues(form),fieldNames={username:"Username",firstname:"First Name",lastname:"Last Name",email:"Email",password:"Password"};for(var field in formValues)"username"!=field&&$('input[name="'+field+'"]').blur(function(){var field=this.name;if(constraints[field]){var v=validate.single(this.value,constraints[field]);if(v){var msg="";msg+=fieldNames[field]+" ",msg+=v[0],$(this).parent().parent().find(".field-validation."+field).text(msg)}else $(this).parent().parent().find(".field-validation."+field).text("")}});$("#signup").on("submit",function(e){e.preventDefault();var formValues=validate.collectFormValues(form),result=validate(formValues,constraints);if("object"==typeof result){var msg="";for(var field in result)msg+=result[field]+" ";$(".field-validation.submit").text(msg)}else this.submit()}),$("#request-invite").on("submit",function(e){(e.preventDefault(),validate.single($("#email").val(),constraints.email))?$(".field-validation").text("Not a valid email address"):this.submit()})}$(".topnav-user-menu").length>0&&$("#user-link").on("click",function(e){e.preventDefault(),"none"==$(".topnav-user-menu").css("display")?$(".topnav-user-menu").css("display","inline-block"):$(".topnav-user-menu").css("display","none")});var lastSeen=1,cb=function(p){lastSeen=p};$.ajax({url:"/api/user/notifications"}).done(function(data){if(data.success){parseInt(data.last_seen)>parseInt(readCookie("last_notify"))&&$(".button-badge").show(),cb(data.last_seen);var container=$("<ul>");for(var i in data.notifications){var li=$("<li>");li.text(data.notifications[i].message),li.append("<br>"),li.append("on "+moment(data.notifications[i].date).format("M/D [at] h:mm a")),container.append(li)}if(0==data.notifications.length){var li=$("<li>You have no notifications</li>");container.append(li)}$("nav.topnav .dropdown").html(container)}else"no results"==data.error&&$("nav.topnav .dropdown").html("<li>No new notifications</li>")}),$(".alertbell").on("mousedown",null,lastSeen,function(e){$("nav.topnav .dropdown").toggle(),$(".button-badge").hide(),createCookie("last_notify",lastSeen,30)}),$(document).on("click",function(e){!$("nav.topnav .dropdown").is(":visible")||$(e.target).hasClass("dropdown")||$(e.target).hasClass("fa-bell")||$("nav.topnav .dropdown").hide()});